<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalExceptionMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">quarkus-dashboard-generator</a> &gt; <a href="index.source.html" class="el_package">io.hoggmania.dashboard.exception</a> &gt; <span class="el_source">GlobalExceptionMapper.java</span></div><h1>GlobalExceptionMapper.java</h1><pre class="source lang-java linenums">package io.hoggmania.dashboard.exception;

import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.core.UriInfo;
import jakarta.ws.rs.core.HttpHeaders;
import jakarta.ws.rs.ext.ExceptionMapper;
import jakarta.ws.rs.ext.Provider;
import jakarta.ws.rs.core.Context;

import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.core.JsonProcessingException;
import io.quarkus.logging.Log;

@Provider
<span class="nc" id="L16">public class GlobalExceptionMapper implements ExceptionMapper&lt;Exception&gt; {</span>

    @Context
    UriInfo uriInfo;

    @Context
    HttpHeaders headers;

    @Override
    public Response toResponse(Exception exception) {
        // Log the full exception for diagnostics during tests
<span class="nc" id="L27">        Log.error(&quot;Unhandled exception in request processing&quot;, exception);</span>
<span class="nc" id="L28">        boolean wantsHtml = false;</span>
<span class="nc bnc" id="L29" title="All 4 branches missed.">        String path = uriInfo != null &amp;&amp; uriInfo.getPath() != null ? uriInfo.getPath() : &quot;&quot;;</span>
<span class="nc bnc" id="L30" title="All 4 branches missed.">        if (path.startsWith(&quot;ui&quot;) || path.startsWith(&quot;/ui&quot;)) {</span>
<span class="nc" id="L31">            wantsHtml = true;</span>
        }
<span class="nc bnc" id="L33" title="All 4 branches missed.">        if (headers != null &amp;&amp; headers.getAcceptableMediaTypes() != null) {</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">            for (var mt : headers.getAcceptableMediaTypes()) {</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">                if (MediaType.TEXT_HTML_TYPE.isCompatible(mt)) {</span>
<span class="nc" id="L36">                    wantsHtml = true;</span>
<span class="nc" id="L37">                    break;</span>
                }
<span class="nc" id="L39">            }</span>
        }

        Response.ResponseBuilder builder;
        String title;
        String msg;
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (exception instanceof ValidationException) {</span>
<span class="nc" id="L46">            builder = Response.status(Response.Status.BAD_REQUEST);</span>
<span class="nc" id="L47">            title = &quot;Validation Error&quot;;</span>
<span class="nc" id="L48">            msg = exception.getMessage();</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">            return wantsHtml ? builder.entity(buildHtml(title, msg)).type(MediaType.TEXT_HTML).build()</span>
<span class="nc" id="L50">                    : builder.entity(new ErrorResponse(title, msg)).build();</span>
        }
        
<span class="nc bnc" id="L53" title="All 4 branches missed.">        if (exception instanceof JsonMappingException || exception instanceof JsonProcessingException) {</span>
<span class="nc" id="L54">            builder = Response.status(Response.Status.BAD_REQUEST);</span>
<span class="nc" id="L55">            title = &quot;JSON Parsing Error&quot;;</span>
<span class="nc" id="L56">            msg = &quot;Invalid JSON format: &quot; + exception.getMessage();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            return wantsHtml ? builder.entity(buildHtml(title, msg)).type(MediaType.TEXT_HTML).build()</span>
<span class="nc" id="L58">                    : builder.entity(new ErrorResponse(title, msg)).build();</span>
        }
        
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (exception instanceof IllegalArgumentException) {</span>
<span class="nc" id="L62">            builder = Response.status(Response.Status.BAD_REQUEST);</span>
<span class="nc" id="L63">            title = &quot;Invalid Argument&quot;;</span>
<span class="nc" id="L64">            msg = exception.getMessage();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            return wantsHtml ? builder.entity(buildHtml(title, msg)).type(MediaType.TEXT_HTML).build()</span>
<span class="nc" id="L66">                    : builder.entity(new ErrorResponse(title, msg)).build();</span>
        }
        
        // Generic server error for unexpected exceptions
<span class="nc" id="L70">        builder = Response.status(Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L71">        title = &quot;Internal Server Error&quot;;</span>
<span class="nc" id="L72">        msg = &quot;An unexpected error occurred&quot;;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        return wantsHtml ? builder.entity(buildHtml(title, msg)).type(MediaType.TEXT_HTML).build()</span>
<span class="nc" id="L74">                : builder.entity(new ErrorResponse(title, msg)).build();</span>
    }
    
    public static class ErrorResponse {
        public String error;
        public String message;
        
<span class="nc" id="L81">        public ErrorResponse(String error, String message) {</span>
<span class="nc" id="L82">            this.error = error;</span>
<span class="nc" id="L83">            this.message = message;</span>
<span class="nc" id="L84">        }</span>
    }

    private String buildHtml(String title, String message) {
<span class="nc" id="L88">        return &quot;&lt;!DOCTYPE html&gt;\n&quot; +</span>
                &quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot; +
<span class="nc" id="L90">                &quot;&lt;head&gt;&lt;meta charset=\&quot;UTF-8\&quot;&gt;&lt;title&gt;&quot; + escape(title) + &quot;&lt;/title&gt;&quot; +</span>
                &quot;&lt;style&gt;body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#222}&quot; +
                &quot;.msg{padding:12px 14px;border-radius:6px;margin-bottom:16px;background:#fee;border:1px solid #e99;color:#900;white-space:pre-wrap}&lt;/style&gt;&quot; +
                &quot;&lt;/head&gt;\n&quot; +
                &quot;&lt;body&gt;\n&quot; +
<span class="nc" id="L95">                &quot;&lt;h1&gt;&quot; + escape(title) + &quot;&lt;/h1&gt;\n&quot; +</span>
<span class="nc" id="L96">                &quot;&lt;div class=\&quot;msg\&quot;&gt;&quot; + escape(message) + &quot;&lt;/div&gt;\n&quot; +</span>
                &quot;&lt;a href=\&quot;/ui\&quot;&gt;Back&lt;/a&gt;\n&quot; +
                &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
    }

    private String escape(String s) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (s == null) return &quot;&quot;;</span>
<span class="nc" id="L103">        return s.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;).replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;).replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>