<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JiraClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">quarkus-dashboard-generator</a> &gt; <a href="index.source.html" class="el_package">io.hoggmania.dashboard.service</a> &gt; <span class="el_source">JiraClient.java</span></div><h1>JiraClient.java</h1><pre class="source lang-java linenums">package io.hoggmania.dashboard.service;

import java.io.IOException;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.Duration;
import java.io.FileInputStream;
import java.security.KeyStore;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManagerFactory;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import io.hoggmania.dashboard.exception.ValidationException;
import io.hoggmania.dashboard.util.UrlUtils;
import io.hoggmania.dashboard.util.StringUtils;
import io.hoggmania.dashboard.util.RateLimiter;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.eclipse.microprofile.config.inject.ConfigProperty;

/**
 * HTTP client for interacting with Jira REST API.
 * Supports custom trust stores for enterprise Jira instances
 * and includes rate limiting to prevent API throttling.
 */
@ApplicationScoped
public class JiraClient {

    private final HttpClient httpClient;
    private final RateLimiter rateLimiter;

    @Inject
    ObjectMapper mapper;

    @Inject
    public JiraClient(
            @ConfigProperty(name = &quot;jira.trust-store&quot;) java.util.Optional&lt;String&gt; trustStorePath,
            @ConfigProperty(name = &quot;jira.trust-store-password&quot;) java.util.Optional&lt;String&gt; trustStorePassword,
            @ConfigProperty(name = &quot;jira.rate-limit.max-requests&quot;, defaultValue = &quot;100&quot;) int maxRequests,
<span class="nc" id="L44">            @ConfigProperty(name = &quot;jira.rate-limit.window-seconds&quot;, defaultValue = &quot;60&quot;) int windowSeconds) {</span>
<span class="nc" id="L45">        this.httpClient = createClient(trustStorePath, trustStorePassword);</span>
<span class="nc" id="L46">        this.rateLimiter = new RateLimiter(maxRequests, Duration.ofSeconds(windowSeconds));</span>
<span class="nc" id="L47">    }</span>

    private HttpClient createClient(java.util.Optional&lt;String&gt; trustStorePath, java.util.Optional&lt;String&gt; trustStorePassword) {
        try {
<span class="nc" id="L51">            HttpClient.Builder builder = HttpClient.newBuilder().connectTimeout(Duration.ofSeconds(10));</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (trustStorePath.isPresent()) {</span>
<span class="nc" id="L53">                String path = trustStorePath.get();</span>
<span class="nc" id="L54">                char[] password = trustStorePassword.orElse(&quot;&quot;).toCharArray();</span>
<span class="nc" id="L55">                KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span>
<span class="nc" id="L56">                try (FileInputStream fis = new FileInputStream(path)) {</span>
<span class="nc" id="L57">                    keyStore.load(fis, password);</span>
                }
<span class="nc" id="L59">                TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span>
<span class="nc" id="L60">                tmf.init(keyStore);</span>
<span class="nc" id="L61">                SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);</span>
<span class="nc" id="L62">                sslContext.init(null, tmf.getTrustManagers(), null);</span>
<span class="nc" id="L63">                builder.sslContext(sslContext);</span>
            }
<span class="nc" id="L65">            return builder.build();</span>
<span class="nc" id="L66">        } catch (Exception e) {</span>
<span class="nc" id="L67">            throw new ValidationException(&quot;Failed to load Jira trust store: &quot; + e.getMessage());</span>
        }
    }

    /**
     * Fetches a Jira issue by key with all linked issues and changelog.
     * Includes rate limiting per Jira instance to prevent overwhelming the API.
     * 
     * @param baseUrl the Jira instance base URL (e.g., https://jira.example.com)
     * @param issueKey the issue key (e.g., PROJ-123)
     * @param personalAccessToken the personal access token for authentication
     * @return the issue data as a JsonNode
     * @throws ValidationException if parameters are invalid, rate limit is exceeded, or the API call fails
     */
    public JsonNode fetchIssue(String baseUrl, String issueKey, String personalAccessToken) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (StringUtils.isBlank(baseUrl)) {</span>
<span class="nc" id="L83">            throw new ValidationException(&quot;Jira base URL is required.&quot;);</span>
        }
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (StringUtils.isBlank(issueKey)) {</span>
<span class="nc" id="L86">            throw new ValidationException(&quot;Jira issue key is required.&quot;);</span>
        }
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (StringUtils.isBlank(personalAccessToken)) {</span>
<span class="nc" id="L89">            throw new ValidationException(&quot;A Jira personal access token is required.&quot;);</span>
        }

        // Rate limiting per base URL to prevent overwhelming the Jira instance
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!rateLimiter.tryAcquire(baseUrl)) {</span>
<span class="nc" id="L94">            throw new ValidationException(&quot;Rate limit exceeded for Jira instance: &quot; + baseUrl + </span>
                &quot;. Please try again later.&quot;);
        }

        try {
<span class="nc" id="L99">            String normalizedBase = UrlUtils.normalizeBaseUrl(baseUrl);</span>
<span class="nc" id="L100">            String encodedKey = UrlUtils.encode(issueKey);</span>
<span class="nc" id="L101">            URI uri = URI.create(normalizedBase + &quot;/rest/api/3/issue/&quot; + encodedKey + &quot;?expand=renderedFields,changelog&quot;);</span>
<span class="nc" id="L102">            HttpRequest request = HttpRequest.newBuilder(uri)</span>
<span class="nc" id="L103">                    .timeout(Duration.ofSeconds(20))</span>
<span class="nc" id="L104">                    .GET()</span>
<span class="nc" id="L105">                    .header(&quot;Accept&quot;, &quot;application/json&quot;)</span>
<span class="nc" id="L106">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + personalAccessToken.trim())</span>
<span class="nc" id="L107">                    .build();</span>
<span class="nc" id="L108">            HttpResponse&lt;String&gt; response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (response.statusCode() &gt;= 400) {</span>
<span class="nc" id="L110">                throw new ValidationException(&quot;Failed to fetch Jira issue &quot; + issueKey + &quot;: HTTP &quot; + response.statusCode());</span>
            }
<span class="nc" id="L112">            return mapper.readTree(response.body());</span>
<span class="nc" id="L113">        } catch (ValidationException e) {</span>
<span class="nc" id="L114">            throw e;</span>
<span class="nc" id="L115">        } catch (IOException e) {</span>
<span class="nc" id="L116">            throw new ValidationException(&quot;Unable to call Jira API: &quot; + e.getMessage());</span>
<span class="nc" id="L117">        } catch (InterruptedException e) {</span>
<span class="nc" id="L118">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L119">            throw new ValidationException(&quot;Jira API call was interrupted: &quot; + e.getMessage());</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>