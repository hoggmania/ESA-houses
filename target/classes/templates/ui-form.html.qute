<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESA Dashboard - Paste JSON</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #222; }
    h1 { margin-top: 0; }
    .msg { padding: 12px 14px; border-radius: 6px; margin-bottom: 16px; }
    .error { background: #fee; border: 1px solid #e99; color: #900; white-space: pre-wrap; }
    textarea { width: 100%; min-height: 340px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 14px; line-height: 1.4; padding: 12px; border-radius: 8px; border: 1px solid #bbb; }
    .row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
    button { appearance: none; background: #0d6efd; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button.secondary { background: #6c757d; }
    .hint { color: #555; font-size: 13px; margin-top: 8px; }
    footer { margin-top: 24px; color: #666; font-size: 12px; }
  </style>
  <script>
    const STORAGE_KEY = 'esa-dashboard-payload';

    function trySavePayload(value) {
      try {
        localStorage.setItem(STORAGE_KEY, value);
      } catch (err) {
        console.warn('Unable to persist payload', err);
      }
    }

    function hydratePayloadFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          document.getElementById('payload').value = stored;
        }
      } catch (err) {
        console.warn('Unable to read stored payload', err);
      }
    }

    function pasteSample() {
      fetch('/ui/sample').then(r => r.text()).then(t => {
        const textarea = document.getElementById('payload');
        textarea.value = t;
        trySavePayload(t);
      }).catch(err => {
        alert('Failed to load sample: ' + err);
      });
    }

    function renderText() {
      const payload = document.getElementById('payload').value;
      trySavePayload(payload);
      fetch('/ui/render-text', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: payload
      }).then(async (res) => {
        const html = await res.text();
        document.open();
        document.write(html);
        document.close();
      }).catch(err => {
        alert('Failed to render: ' + err);
      });
    }

    window.addEventListener('DOMContentLoaded', hydratePayloadFromStorage);
  </script>
</head>
<body>
  <h1>ESA Dashboard</h1>
  <p class="hint">Paste your JSON below and click Render. Use the Sample button if you want a starter payload.</p>

  {#if message}
    <div class="msg error">{message}</div>
  {/if}

  <form onsubmit="event.preventDefault(); renderText();">
    <textarea id="payload" name="payload" spellcheck="false">{payload}</textarea>
    <div class="row">
      <button type="button" onclick="renderText()">Render</button>
      <button type="button" class="secondary" onclick="pasteSample()">Paste Sample</button>
    </div>
  </form>

  <footer>
    Tip: The output will render as SVG on the next page, with an option to download a PNG.
  </footer>
</body>
</html>
